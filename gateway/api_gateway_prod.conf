upstream user-service {
    zone upstream-imageApp 64k;
    least_conn;
    server user-service:460 max_fails=3 fail_timeout=60 weight=1;
}

upstream auth-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server auth-service:461 max_fails=3 fail_timeout=60 weight=1;
}

upstream post-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server post-service:462 max_fails=3 fail_timeout=60 weight=1;
}

upstream story-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server story-service:464 max_fails=3 fail_timeout=60 weight=1;
}

upstream media-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server media-service:465 max_fails=3 fail_timeout=60 weight=1;
}

server {
    access_log /var/log/nginx/api_access.log main;

    listen 8085 default_server;
    
    location /api/users {
        limit_except GET POST PUT OPTIONS DELETE { deny all; }
        proxy_pass http://user-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /api/auth {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass http://auth-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /api/media {
            limit_except GET { deny all; }
            proxy_pass http://media-service;
            rewrite ^/(.*)$ /$1 break;
        }

    location /api/posts {
        set $permissions '["create_post"]';
        auth_request /api/auth/has-role;
        limit_except POST GET PUT { deny all; }
        proxy_pass http://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

     location /api/story {
        set $permissions '["create_post"]';
        auth_request /api/auth/has-role;
        limit_except POST GET PUT { deny all; }
        proxy_pass http://story-service;
        rewrite ^/(.*)$ /$1 break;
     }

    location /api/hello-world/test {
        set $permissions "[admin]";
        auth_request /auth;
        proxy_pass http://user-service;
        rewrite ^/api/hello-world/test/(.*)$ /$1 break;
    }

    location /api/auth/has-role {
        internal;
        proxy_pass http://auth-service;
        proxy_pass_request_body off;
        proxy_set_header X-permissions $permissions;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }




}