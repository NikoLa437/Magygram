upstream user-service {
    zone upstream-imageApp 64k;
    least_conn;
    server host.docker.internal:460 max_fails=3 fail_timeout=60 weight=1;
}

upstream auth-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server host.docker.internal:461 max_fails=3 fail_timeout=60 weight=1;
}

upstream post-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server host.docker.internal:462 max_fails=3 fail_timeout=60 weight=1;
}

upstream story-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server host.docker.internal:464 max_fails=3 fail_timeout=60 weight=1;
}

upstream media-service {
    zone upstream-ecommerceApp 64k;
    least_conn;
    server host.docker.internal:465 max_fails=3 fail_timeout=60 weight=1;
}

server {
    access_log /var/log/nginx/api_access.log main;

    listen 443 ssl;
    ssl_certificate     /etc/nginx/ssl/certificate.pem;
    ssl_certificate_key /etc/nginx/ssl/certificate-key.pem;

    location /api/users {

        #login and account activation,reset password
        location /api/users/activate/(.*) {
            limit_except GET { deny all; }
            proxy_pass https://user-service;
        }

        location /api/users/reset-password-link-request {
            limit_except POST { deny all; }
            proxy_pass https://user-service;
        }

        location /api/users/reset-password/(.*) {
            limit_except GET { deny all; }
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/image {
            limit_except PUT { deny all; }
            set $permissions '["edit_profile_photo"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/profile {
            limit_except GET { deny all; }
            set $permissions '["view_user_profile"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        #deo sa follow
        location ~ /api/users/(.*)/is-private {
            limit_except GET { deny all; }
            set $permissions '["edit_profile"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/followed {
            limit_except GET { deny all; }
            set $permissions '["view_followers"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/following {
            limit_except GET { deny all; }
            set $permissions '["view_following"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/follow-requests {
            limit_except GET { deny all; }
            set $permissions '["get_follow_request"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/follow-requests/(.*)/accept {
            limit_except POST { deny all; }
            set $permissions '["accept_follow_request"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/follow {
            limit_except POST { deny all; }
            set $permissions '["follow"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/unfollow {
            limit_except POST { deny all; }
            set $permissions '["unfollow"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }
        #KRAJ FOLLOW

        #search
        location ~ /api/users/search/(.*)/user {
            limit_except GET { deny all; }
            set $permissions '["search"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/search/(.*)/guest {
            limit_except GET { deny all; }
            proxy_pass https://user-service;
        }
        #KRAJ SEARCH


        #start highlights

        location /api/users/highlights {
            limit_except POST { deny all; }
            set $permissions '["create_highlights"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/highlights {
            limit_except GET { deny all; }
            set $permissions '["get_profile_highlights"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/(.*)/highlights/(.*) {
            limit_except GET { deny all; }
            set $permissions '["get_profile_highlights"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }
        #end highlights

        #start collections

        location /api/users/collections {
            limit_except POST GET { deny all; }
            set $permissions '["create_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/collections/posts {
            limit_except POST { deny all; }
            set $permissions '["add_post_to_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/collections/(.*)/posts {
            limit_except GET { deny all; }
            set $permissions '["get_post_from_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/collections/(.*)/posts {
            limit_except GET { deny all; }
            set $permissions '["get_post_from_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/collections/posts/(.*) {
            limit_except DELETE { deny all; }
            set $permissions '["detele_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/collections/posts/(.*) {
            limit_except DELETE { deny all; }
            set $permissions '["detele_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/collections/except-default {
            limit_except GET { deny all; }
            set $permissions '["get_user_collection"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/collections/check-favourites {
            limit_except POST { deny all; }
            set $permissions '["check_post_favourites"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }
        #end collections

        location /api/users/logged {
            limit_except GET { deny all; }
            set $permissions '["get_logged_info"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location ~ /api/users/[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]*  {
            limit_except PUT { deny all; }
            set $permissions '["edit_profile"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }

        location /api/users/reset-password {
            limit_except POST { deny all; }
            proxy_pass https://user-service;
        }

        location /api/users/resend-activation-link {
            limit_except POST { deny all; }
            proxy_pass https://user-service;
        }

        location ~ /api/users/check-existence/[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]* {
            limit_except GET { deny all; }
            proxy_pass https://user-service;
        }

        location ~ /api/users/[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]*-[a-f0-9]* {
            limit_except GET { deny all; }
            set $permissions '["view_user_profile"]';
            auth_request /api/auth/has-role;
            proxy_pass https://user-service;
        }


        location /api/users {
            limit_except POST { deny all; }
            proxy_pass https://user-service;
            rewrite ^/(.*)$ /$1 break;
        }
    }


    location /api/auth {
        limit_except GET POST PUT OPTIONS { deny all; }
        proxy_pass https://auth-service;
        rewrite ^/(.*)$ /$1 break;
    }

    location /api/media {
            limit_except GET { deny all; }
            proxy_pass https://media-service;
            rewrite ^/(.*)$ /$1 break;
        }

    location /api/posts {
        limit_except POST GET PUT { deny all; }
        proxy_pass https://post-service;
        rewrite ^/(.*)$ /$1 break;
    }

     location /api/story {
        limit_except POST GET PUT { deny all; }
        proxy_pass https://story-service;
        rewrite ^/(.*)$ /$1 break;
     }

    location /api/hello-world/test {
        set $permissions "[admin]";
        auth_request /auth;
        proxy_pass https://user-service;
        rewrite ^/api/hello-world/test/(.*)$ /$1 break;
    }

    location /api/auth/has-role {
        internal;
        proxy_pass https://auth-service;
        proxy_pass_request_body off;
        proxy_set_header X-permissions $permissions;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }




}